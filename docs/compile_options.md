# Compile options

Your Fortran compiler is your friend and has a lot of useful command line
options.  Unfortunately, they are vendor specific, so you have to check the
documentation of the compiler you are using.  Here you will find some useful
options for GCC's gfortran and Intel's ifort compilers.  The options are
organized by category, e.g., debugging, performance and so on.

Many compiler flags are actually handled by CMake, so that you don't have to
set those explicitly.


## Debugging

The most important flag for debugging is `-g`, which will be set automatically
when `CMAKE_BUILD_TYPE` is `Debug` or `RelWithDebInfo`.  It ensures that source
information is added to the executable or library.

For compilers that optimize by default, you would also set `-O0`, i.e., no
optimization because that tends to complicate debugging since the compiler may
remove or replace some statements.  For GCC this is not required, but it may be
for Intel's ifort.

Note that the `-g` flag by itself has no influence on the performance of your
executable, although it increases the file size.  This makes the flag also
useful in the context of profiling.

The compiler can also generate extra warnings, and it is good practice to let
it do so.  Be sure to eliminate warnings by improving your code.  Almost all
warnings should be heeded, unless you are really sure what you are doing

Every compiler allows very detailed control over the warnings it generates, and
it is possible to switch on an off specific warnings on a case by case basis.

In general, it is good practice to switch on a wide range of warnings which is
easy with most compilers.


### GCC

For GCC, `-Wall` and `-Wextra` are quite useful.  They will warn about a wide
range of potential issues such as using variables that might not have been
initialized, testing floating point values for equality, variables that are
declared but not used and so on.

For even more warnings, add `-pedantic`.

Detailed information on the warnings generated by these families of options can
be found in the compiler's documentation.

You can have the compiler insert code to check that you don't try to access
arrays using indices that are out of bounds by using the `-fbounds-check`.
However, keep in mind that this will decrease the performance slightly since
the code to check the bounds has to be executed, so do not use this flag for
a build that you intend for production or release.


###  Intel

For ifort, the relevant option is `-warn all`, and `-diag-enable remark` will
turn on many warnings.

You can have the compiler insert code to check that you don't try to access
arrays using indices that are out of bounds by using the `-check bounds`.
However, keep in mind that this will decrease the performance slightly since
the code to check the bounds has to be executed, so do not use this flag for
a build that you intend for production or release.

The Intel compiler can check explicitly at runtime for the use of
uninitialized variables if you use the `-check uninit` flag.

By default, the Intel compilers support quite some extensions to Fortran for
historical reasons.  If you want it to be strict about a standard, you can
force that using the `-stand <spec>` flag, where `<spec>` is any of
`f77`, `f90`, `f95`, `f03`, `f08`, `f18`.


## Profiling

If you want to improve the performance of your code, it is good practice to
measure the time spent in procedures, so that you know which ones to
concentrate your efforts on.  It doesn't make much sense to try and improve the
performance of a procedure that takes only 1 % of the total run time.

There are many tools to measure the performance of your code, some open source,
some commercial.  A very simple one is `gprof` and this is supported by GCC.

The `-pg` flag for both compiling and linking will instrument your application
to generate statistics of the time spent in functions, the number of function
calls and so on.  Once the application, e.g., `my_applexe` has run, you can
display the performance statistics using:

~~~~bash
$ gprof my_applexe
~~~~


## Optimization

Compilers can be used with various levels of optimization controlled via
command line options
* `-O0`: no optimization,
* `-Os`: minimize the size of the executable,
* `-O1` to `-O3`: apply increasing levels of optimization.

Note that the level of optimization may impact the results.  At `-O3`,
(GCC) the compiler can reorder numerical expressions, so you may get
different results.  For Intel compilers, this happens even at `-O2`.

It may help to let the compiler generate machine code specific for the
hardware you are running on.  When you use `march=native` the instruction set
most suited for the hardware you are building your application on will be used,
in general resulting in the best performance.
